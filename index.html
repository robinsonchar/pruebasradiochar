<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- ARQUITECTURA VISUAL RADIOCHAR V7 (NIVEL MASTER) --- */
        #radiochar-ai-dj-container {
            display: flex;
            align-items: center;
            padding: 24px;
            gap: 28px;
            max-width: 900px;
            margin: 20px auto;
            background: linear-gradient(145deg, rgba(20,20,25,0.95), rgba(10,10,15,1));
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            color: #ffffff;
            min-height: 150px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            /* Asegurar visibilidad en cualquier entorno */
            opacity: 1 !important;
            visibility: visible !important;
            position: relative;
            z-index: 9999;
        }

        .dj-avatar-frame {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
        }

        .dj-avatar-frame::after {
            content: "";
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 300% 300%;
            animation: gradient-rotate 4s linear infinite;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        @keyframes gradient-rotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dj-avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            background: #111;
            border: 3px solid #000;
        }

        .dj-data-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }

        .dj-status-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .badge-en-cabina {
            background: #ff0000;
            color: #fff;
            font-size: 10px;
            font-weight: 900;
            padding: 5px 12px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            box-shadow: 0 0 15px rgba(255,0,0,0.6);
        }

        .dj-name-text {
            color: #f1c40f;
            font-size: 1.5rem;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .dj-ai-script-box {
            font-size: 1.1rem;
            line-height: 1.5;
            margin: 0;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
        }

        .dj-ai-script-box b { color: #fff; font-weight: 700; }

        .typing-indicator {
            display: flex;
            gap: 4px;
            color: #4facfe;
            font-style: italic;
            font-size: 0.9rem;
            align-items: center;
        }

        .dot {
            width: 5px; height: 5px; background: currentColor;
            border-radius: 50%; animation: blink 1s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

        @media (max-width: 650px) {
            #radiochar-ai-dj-container { flex-direction: column; text-align: center; }
            .dj-status-header { justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="radiochar-ai-dj-container">
        <div class="dj-avatar-frame">
            <img id="ai-dj-avatar" src="" alt="DJ" class="dj-avatar-img">
        </div>
        <div class="dj-data-panel">
            <div class="dj-status-header">
                <span class="badge-en-cabina">En Cabina</span>
                <h2 id="ai-dj-name" class="dj-name-text">DJ RADIOCHAR</h2>
            </div>
            <div id="ai-dj-comment" class="dj-ai-script-box">
                Escaneando se√±al de audio...
            </div>
        </div>
    </div>

    <script>
        /**
         * RADIOCHAR AI CORE - MASTER AUDIT V7
         */
        const CONFIG = {
            WORKER: 'https://bitter-river-7a49.robinsoncharjuelan.workers.dev',
            DATA_URL: 'https://raw.githubusercontent.com/robinsonchar/radiochar/refs/heads/main/PERSONALIDAD_DJS.JSON',
            SELECTORS: [
                '.now-playing-title', '#cc_strinfo_track_radiochar', 
                '.play-title', '#title', '.current-song', 
                '.titulo-cancion', '.track-info b', 'h2.song-title'
            ],
            // DJ DE RESPALDO (Previene el error UNDEFINED instant√°neamente)
            DEFAULT_DJ: {
                nombre: "Danna Cifuentes",
                personalidad: "Elegante, sofisticada, nocturna. Ambiente de club exclusivo.",
                tono: "Sugerente y c√°lido",
                imagen: "https://raw.githubusercontent.com/robinsonchar/pruebasradiochar/refs/heads/main/danna_cifuentes.jpg"
            }
        };

        let state = {
            djs: [CONFIG.DEFAULT_DJ],
            currentDJ: CONFIG.DEFAULT_DJ,
            lastSong: "",
            isWorking: false
        };

        // 1. Inicializaci√≥n de UI inmediata (Evita que el usuario vea "undefined")
        function syncUI() {
            document.getElementById('ai-dj-name').innerText = `DJ ${state.currentDJ.nombre}`;
            document.getElementById('ai-dj-avatar').src = state.currentDJ.imagen;
        }

        async function bootstrap() {
            console.log("üõ°Ô∏è Master Audit: Motor iniciado.");
            syncUI();

            try {
                // Intentar cargar DJs, si falla (CORS local), seguimos con el default
                const res = await fetch(CONFIG.DATA_URL);
                const data = await res.json();
                state.djs = Array.isArray(data) ? data : (Object.values(data)[0] || [CONFIG.DEFAULT_DJ]);
                console.log("‚úÖ DJs externos sincronizados.");
            } catch (e) {
                console.warn("‚ö†Ô∏è Ejecuci√≥n en local o error de red detectado. Usando DJ de respaldo.");
            }

            updateDJByHour();
            startMonitoring();
        }

        function updateDJByHour() {
            const hour = new Date().getHours();
            const found = state.djs.find(dj => {
                if (!dj.franja_horaria) return false;
                const hours = dj.franja_horaria.match(/\d+/g);
                return hours && hour >= parseInt(hours[0]) && hour <= parseInt(hours[1]);
            });

            state.currentDJ = found || state.djs[0] || CONFIG.DEFAULT_DJ;
            syncUI();
        }

        function startMonitoring() {
            // Monitor de alta frecuencia (Cada 3 seg) para asegurar captura
            setInterval(scan, 3000);
            
            // Observador de cambios en el DOM
            const observer = new MutationObserver(() => scan());
            observer.observe(document.body, { childList: true, subtree: true, characterData: true });
            
            scan();
        }

        function scan() {
            if (state.isWorking) return;
            
            let song = "";
            const self = document.getElementById('radiochar-ai-dj-container');

            for (let s of CONFIG.SELECTORS) {
                const el = document.querySelector(s);
                // No leerse a s√≠ mismo
                if (el && !self.contains(el)) {
                    const text = el.innerText.trim();
                    if (isValid(text)) {
                        song = text;
                        break;
                    }
                }
            }

            if (song && song !== state.lastSong) {
                console.log(`üéµ Metadata detectada: ${song}`);
                state.lastSong = song;
                askAI(song);
            }
        }

        function isValid(t) {
            if (!t || t.length < 4) return false;
            const blacklist = ["Radiochar", "Sincronizando", "Escaneando", "undefined", "Desconocido", "DJ "];
            return !blacklist.some(b => t.toLowerCase().includes(b.toLowerCase()));
        }

        async function askAI(song) {
            state.isWorking = true;
            const box = document.getElementById('ai-dj-comment');
            
            box.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    <span>DJ ${state.currentDJ.nombre} est√° redactando...</span>
                </div>`;

            try {
                const prompt = `Act√∫a como ${state.currentDJ.nombre}. Personalidad: ${state.currentDJ.personalidad}. Tono: ${state.currentDJ.tono}. Comenta de forma breve (m√°x 15 palabras), muy natural y creativa la canci√≥n "${song}" para Radiochar. No saludes.`;

                const res = await fetch(CONFIG.WORKER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await res.json();
                const comment = data.text || data.result || `Siente la armon√≠a de este √©xito: ${song}.`;

                box.style.opacity = 0;
                setTimeout(() => {
                    box.innerHTML = comment.replace(new RegExp(song, 'gi'), `<b>${song}</b>`);
                    box.style.transition = "opacity 0.6s";
                    box.style.opacity = 1;
                    state.isWorking = false;
                }, 400);

            } catch (err) {
                console.error("‚ùå Worker Error:", err);
                box.innerHTML = `Disfruta de <b>${song}</b> con la mejor energ√≠a de Radiochar.`;
                state.isWorking = false;
            }
        }

        // Arranque forzado
        window.onload = bootstrap;
    </script>
</body>
</html>