 /**
     * RADIOCHAR VIRTUAL DJ ENGINE v2.3
     * Reparación de JSON Crítico + Sincronización Universal de Reproductor
     */

    const DJ_APP = {
        config: {
            FEED_URL: 'https://cast2.my-control-panel.com/recentfeed/robinson/json/',
            INTERVAL: 10000,
            TIMEOUT: 10000,
            // Selectores actualizados para capturar el texto del reproductor en index.html
            PLAYER_SELECTORS: {
                TITLE: '#cc_strinfo_tracktitle_robinson, .cc_strinfo_tracktitle_robinson, .track-title, [class*="track-name"]',
                ARTIST: '#cc_strinfo_trackartist_robinson, .cc_strinfo_trackartist_robinson, .track-artist, [class*="artist-name"]'
            },
            PROGRAMS: [
                { id: 'lover', name: 'Miranda Fuentes', img: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjzrMy5dZ_8OTNe_Jnb8oUnMiiZwnu7wSjX5NelzvEGveoffAgKviwv7kDf4eKQw8RokK26d01KU9c_ctAyWeurqSRP3w9_17kCkyytSkk-0ZQHeH3PDLeMQTVGFceCpzTWz1Nb6xS9-GMnyqQGtPPk6DLIHggNxNxeiJUUD7l9VPZKK6x-WaWIs6aTwGCc/s16000/DannaDJ.png', json: 'https://robinsonchar.github.io/radiochar/frases-lover-city.JSON', start: 0, end: 5 },
                { id: 'wonders', name: 'Jhon Martin', img: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhSfxftwe5xsNVyEXUjnWLO9-EZFFzrdWq4tfmRrd-fvY6nGgQ8o7OiWhGvTAdO6_smQt_pgo5tHty-t64RXCPDZGbBKlKFoQwF2r14Z3b1f_C6YXjynGA2I1eOYKbh03PMQ7OMnrlnkHO7v_y-x6yygp3DKG0ifVBoKjlPtd5o2II0TCGlxI7K3wuRi2P_/s16000/JhonDJ.png', json: 'https://robinsonchar.github.io/radiochar/frases-the-wonders.json', start: 5, end: 10 },
                { id: 'piedras', name: 'Tito González', img: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgQ_a3bu8sIVyMUg25K9MjRuCC7xLmUncSSmT3HhOpoVO8Cu9_VsfzfP8y0jvOf5V9y5oioQ8jOYOPicRfA8fTS0n9evteaNPCI3M6VsjwS2HFtbHmuuEsmSd6pUcWqK2nTG-FVeHo0Wa6lgC8RxA_5wVtA9g6Bxq35fFqUOXMT667ih5lag5q_r6VZFcCB/s16000/TitoDJ.png', json: 'https://robinsonchar.github.io/radiochar/frases-pateando-piedras.JSON', start: 10, end: 15 },
                { id: 'rockstars', name: 'Salma Cifuentes', img: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghGlBQlHUoFaWx8hg6hsmVW9zN0yvCpwAa6ar51eluTrhKwGvtp6SO-0KBoEGVl6U0T5zRj4ufIA4LasO79JHjvJlLgPEsbK952xUmw-s4OmWFuh5xQluZJkmbPRhRCeKNmyb8s0LDRtuYhUVVmYShe3eHWSVgUrlrbFM05wYBjLclkBL7h26XLScojLd-/s16000/SalmaDJ.png', json: 'https://robinsonchar.github.io/radiochar/frases-rockstars.JSON', start: 15, end: 20 },
                { id: 'hits', name: 'Karol Morales', img: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgDzoq_pTmC45CLGbrYWwHAjVegHcJ6h0adHxybVEBXOjp0tzRwesUhAHieyNfA6tAijA1wW79b0NpUwItTgzGEX-_ybsMic9WsSYAshhLu8kT9YxjR8cwNZ_BlsLphXR4wmE7jVmL4yIUJ85VhCzB5EBn0HnXVTJT47DgvcHcA5ouhvOQQgwu5W8iVTpKW/s16000/KarolDJ%20(1).png', json: 'https://robinsonchar.github.io/radiochar/frases-hits-dont-lie.JSON', start: 20, end: 24 }
            ],
            FALLBACKS: [
                "¡Disfruta de la mejor música en Radiochar!",
                "Conectados con tu ritmo las 24 horas.",
                "Siente la energía de nuestra programación virtual.",
                "Transmitiendo éxitos sin fronteras."
            ]
        },
        state: { cache: {}, lastTrackId: null, isFirstRun: true }
    };

    function normalize(str) {
        if (!str) return '';
        return str.toString().toLowerCase().replace(/\(.*\)|\[.*\]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '').trim();
    }

    function getActiveDJ() {
        const hour = new Date().getHours();
        return DJ_APP.config.PROGRAMS.find(p => hour >= p.start && hour < p.end) || DJ_APP.config.PROGRAMS[0];
    }

    /**
     * MODO SALVAMENTO EXTREMO: Escanea texto plano buscando objetos válidos
     */
    function salvageJSON(text) {
        try { return JSON.parse(text); } 
        catch (e) {
            console.warn("JSON Malformado detectado. Iniciando extracción por bloques...");
            // Regex para capturar bloques que contienen "artista" y "frase" o "cancion"
            const regex = /\{[^{}]*"artista"[^{}]*\}/g;
            const matches = text.match(regex);
            if (!matches) return null;
            
            const results = [];
            matches.forEach(m => {
                try {
                    // Limpieza profunda de comillas y caracteres extraños antes de parsear cada fragmento
                    let fragment = m.trim().replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
                    results.push(JSON.parse(fragment));
                } catch(err) {}
            });
            return results.length > 0 ? results : null;
        }
    }

    async function preloadLibrary() {
        const tasks = DJ_APP.config.PROGRAMS.map(async (prog) => {
            try {
                const response = await fetch(`${prog.json}?v=${Date.now()}`);
                if (!response.ok) return;
                const text = await response.text();
                const data = salvageJSON(text);
                if (data) DJ_APP.state.cache[prog.id] = data;
            } catch (err) {
                console.error(`Fallo en precarga de ${prog.id}`);
            }
        });
        await Promise.all(tasks);
    }

    function getPhrase(progId, artist, title) {
        const library = DJ_APP.state.cache[progId];
        if (!library || !Array.isArray(library)) return DJ_APP.config.FALLBACKS[0];

        const normFull = normalize(`${artist}${title}`);
        
        // 1. Coincidencia exacta/parcial
        const match = library.find(item => {
            const iTitle = item.titulo || item.cancion || "";
            const iNorm = normalize(`${item.artista}${iTitle}`);
            return iNorm.length > 3 && (normFull.includes(iNorm) || iNorm.includes(normFull));
        });

        if (match && match.frase) return match.frase;

        // 2. Coincidencia solo por Artista
        const artMatch = library.filter(item => normalize(item.artista).includes(normalize(artist)));
        if (artMatch.length > 0) return artMatch[Math.floor(Math.random() * artMatch.length)].frase;

        // 3. Random del programa
        return library[Math.floor(Math.random() * library.length)].frase || DJ_APP.config.FALLBACKS[0];
    }

    /**
     * LECTURA UNIVERSAL: Captura texto directamente de cualquier elemento de título/artista
     */
    function getTrackFromDOM() {
        try {
            const titleEl = document.querySelector(DJ_APP.config.PLAYER_SELECTORS.TITLE);
            const artistEl = document.querySelector(DJ_APP.config.PLAYER_SELECTORS.ARTIST);
            
            const title = titleEl ? (titleEl.innerText || titleEl.textContent).trim() : "";
            const artist = artistEl ? (artistEl.innerText || artistEl.textContent).trim() : "";
            
            if (title && !title.includes('...') && !title.toLowerCase().includes('loading')) {
                return { artist, title, source: 'DOM' };
            }
        } catch (e) {}
        return null;
    }

    async function getTrackFromFeed() {
        try {
            const response = await fetch(`${DJ_APP.config.FEED_URL}?t=${Date.now()}`);
            const data = await response.json();
            if (data && data.length > 0) return { artist: data[0].artist, title: data[0].title, source: 'FEED' };
        } catch (e) {}
        return null;
    }

    function updateUI(dj, trackInfo, phrase) {
        const container = document.getElementById('dj-content');
        const skeleton = document.getElementById('dj-skeleton');

        if (skeleton) skeleton.classList.add('hidden');
        if (container) container.classList.remove('hidden');

        container.style.opacity = '0';
        container.style.transform = 'translateY(8px)';

        setTimeout(() => {
            document.getElementById('dj-avatar').src = dj.img;
            document.getElementById('dj-name').textContent = dj.name;
            document.getElementById('current-track').textContent = trackInfo;
            
            const phraseClean = phrase.replace(/^["']+|["']+$/g, '').trim();
            document.getElementById('dj-phrase').textContent = phraseClean;

            container.style.opacity = '1';
            container.style.transform = 'translateY(0)';
        }, 300);
    }

    async function syncStation() {
        // Prioridad absoluta a lo que dice el Reproductor en pantalla
        const trackData = getTrackFromDOM() || await getTrackFromFeed();
        
        const artist = trackData ? trackData.artist : "Radiochar";
        const title = trackData ? trackData.title : "Música en vivo";
        
        const currentTrackId = normalize(`${artist}${title}`);
        if (currentTrackId === DJ_APP.state.lastTrackId && !DJ_APP.state.isFirstRun) return;

        const activeDJ = getActiveDJ();
        const phrase = getPhrase(activeDJ.id, artist, title);
        
        updateUI(activeDJ, `${artist} - ${title}`, phrase);
        DJ_APP.state.lastTrackId = currentTrackId;
        DJ_APP.state.isFirstRun = false;
    }

    window.addEventListener('load', async () => {
        await preloadLibrary();
        await syncStation();
        
        // El observador ahora es más profundo para detectar cambios de texto incluso en elementos anidados
        const observer = new MutationObserver(() => syncStation());
        observer.observe(document.body, { childList: true, subtree: true, characterData: true, characterDataOldValue: true });
        
        setInterval(syncStation, DJ_APP.config.INTERVAL);
    });
