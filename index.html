(() => {
  "use strict";

  /* =============================
     CONFIG
  ============================== */

  const FEED_URL = "https://cast2.my-control-panel.com/recentfeed/robinson/json/";
  const REFRESH_INTERVAL = 30000;

  const DJ_PROGRAMS = [
    {
      name: "Morning Beat",
      start: 6,
      end: 12,
      image: "assets/djs/morning.jpg",
      json: "assets/json/morning.json"
    },
    {
      name: "Afternoon Vibes",
      start: 12,
      end: 18,
      image: "assets/djs/afternoon.jpg",
      json: "assets/json/afternoon.json"
    },
    {
      name: "Sunset Groove",
      start: 18,
      end: 22,
      image: "assets/djs/sunset.jpg",
      json: "assets/json/sunset.json"
    },
    {
      name: "Night Flow",
      start: 22,
      end: 24,
      image: "assets/djs/night.jpg",
      json: "assets/json/night.json"
    },
    {
      name: "After Midnight",
      start: 0,
      end: 6,
      image: "assets/djs/after.jpg",
      json: "assets/json/after.json"
    }
  ];

  /* =============================
     STATE
  ============================== */

  const phraseCache = {};
  let lastTrackId = null;

  const djNameEl = document.getElementById("djName");
  const djPhraseEl = document.getElementById("djPhrase");
  const djImageEl = document.getElementById("djImage");

  /* =============================
     UTILITIES
  ============================== */

  function normalizeString(str = "") {
    return str
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s]/gi, "")
      .trim();
  }

  function getCurrentProgram() {
    const hour = new Date().getHours();
    return DJ_PROGRAMS.find(p => hour >= p.start && hour < p.end);
  }

  async function fetchWithTimeout(url, timeout = 5000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);

    try {
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(id);
      if (!res.ok) throw new Error("Network error");
      return await res.json();
    } catch (err) {
      clearTimeout(id);
      throw err;
    }
  }

  async function preloadJSON() {
    const promises = DJ_PROGRAMS.map(async program => {
      try {
        const data = await fetchWithTimeout(program.json);
        phraseCache[program.name] = data;
      } catch {
        phraseCache[program.name] = [];
      }
    });

    await Promise.all(promises);
  }

  async function fetchCurrentTrack() {
    try {
      const data = await fetchWithTimeout(FEED_URL);
      const current = data[0];
      const artist = current.artist || "";
      const title = current.title || "";

      return {
        id: normalizeString(artist + "-" + title),
        artist,
        title
      };
    } catch {
      return null;
    }
  }

  function findPhrase(programName, track) {
    const phrases = phraseCache[programName] || [];
    if (!phrases.length) return `"Disfrutando ${track.title}"`;

    const normalizedTrack = normalizeString(track.artist + " " + track.title);

    let exact = phrases.find(p =>
      normalizeString(p.track) === normalizedTrack
    );

    if (exact) return `"${exact.phrase}"`;

    let partial = phrases.find(p =>
      normalizeString(p.track).includes(normalizedTrack)
    );

    if (partial) return `"${partial.phrase}"`;

    const random = phrases[Math.floor(Math.random() * phrases.length)];
    return `"${random.phrase}"`;
  }

  function renderDJSection(program, phrase) {
    djNameEl.textContent = program.name;
    djImageEl.src = program.image;

    djPhraseEl.classList.add("fade-out");

    setTimeout(() => {
      djPhraseEl.textContent = phrase;
      djPhraseEl.classList.remove("fade-out");
      djPhraseEl.classList.add("fade-in");

      setTimeout(() => {
        djPhraseEl.classList.remove("fade-in");
      }, 400);
    }, 200);
  }

  /* =============================
     MAIN LOOP
  ============================== */

  async function update() {
    const program = getCurrentProgram();
    const track = await fetchCurrentTrack();

    if (!track) {
      djPhraseEl.textContent = `"Conectando con cabina..."`;
      return;
    }

    if (track.id === lastTrackId) return;

    lastTrackId = track.id;

    const phrase = findPhrase(program.name, track);
    renderDJSection(program, phrase);
  }

  /* =============================
     INIT
  ============================== */

  async function init() {
    await preloadJSON();
    update();
    setInterval(update, REFRESH_INTERVAL);
  }

  init();

})();
